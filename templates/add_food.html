{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –µ–¥—É –≤ –¥–Ω–µ–≤–Ω–∏–∫
                </h4>
                <button type="button" class="btn btn-light btn-sm" onclick="addProductRow()">
                    <i class="fas fa-plus"></i> –ï—â–µ –ø—Ä–æ–¥—É–∫—Ç
                </button>
            </div>
            <div class="card-body">
                <form method="POST" id="add-food-form">
                    <!-- –û–±—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã -->
                    <div class="row mb-4">
                        <div class="col-md-6 mb-3">
                            <label for="meal_type" class="form-label">–ü—Ä–∏–µ–º –ø–∏—â–∏ *</label>
                            <select class="form-control" name="meal_type" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–µ–º –ø–∏—â–∏</option>
                                <option value="–∑–∞–≤—Ç—Ä–∞–∫">üåÖ –ó–∞–≤—Ç—Ä–∞–∫</option>
                                <option value="–æ–±–µ–¥">üåû –û–±–µ–¥</option>
                                <option value="—É–∂–∏–Ω">üåô –£–∂–∏–Ω</option>
                                <option value="–ø–µ—Ä–µ–∫—É—Å">üç™ –ü–µ—Ä–µ–∫—É—Å</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="date" class="form-label">–î–∞—Ç–∞ *</label>
                            <input type="date" class="form-control" name="date" 
                                   value="{{ today }}" required>
                        </div>
                    </div>
                    
                    <!-- –ü—Ä–æ–¥—É–∫—Ç—ã -->
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-utensils"></i> –ü—Ä–æ–¥—É–∫—Ç—ã</h6>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addProductRow()">
                                <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç
                            </button>
                        </div>
                        <div class="card-body" id="products-container">
                            <!-- –ü–µ—Ä–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç -->
                            <div class="product-row mb-3" data-index="0">
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <label class="form-label">–ü—Ä–æ–¥—É–∫—Ç *</label>
                                        <select class="form-control product-select" name="product_id[]" required>
                                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç</option>
                                            {% for product in products %}
                                            <option value="{{ product.id }}" 
                                                    data-calories="{{ product.calories_per_100g }}"
                                                    data-protein="{{ product.protein }}"
                                                    data-fat="{{ product.fat }}"
                                                    data-carbs="{{ product.carbs }}"
                                                    data-category="{{ product.category }}"
                                                    {% if selected_product_id == product.id %}selected{% endif %}>
                                                {{ product.name }} ({{ product.category }})
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-4 mb-2">
                                        <label class="form-label">–í–µ—Å (–≥—Ä–∞–º–º) *</label>
                                        <input type="number" class="form-control weight-input" name="weight[]" 
                                               step="0.1" min="0.1" required>
                                    </div>
                                    
                                    <div class="col-md-2 mb-2 d-flex align-items-end">
                                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeProductRow(this)" style="display: none;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ -->
                                <div class="nutrition-preview" style="display: none;">
                                    <div class="alert alert-light">
                                        <small>
                                            <strong class="calories">0</strong> –∫–∫–∞–ª, 
                                            <span class="protein">0</span>–≥ –±–µ–ª–∫–æ–≤, 
                                            <span class="fat">0</span>–≥ –∂–∏—Ä–æ–≤, 
                                            <span class="carbs">0</span>–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    
                    <!-- –û–±—â–∏–π —Ä–∞—Å—á–µ—Ç -->
                    <div class="card bg-success text-white mb-3" id="total-nutrition" style="display: none;">
                        <div class="card-body">
                            <h6 class="card-title"><i class="fas fa-calculator"></i> –û–±—â–∞—è –ø–∏—â–µ–≤–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å:</h6>
                            <div class="row text-center">
                                <div class="col-3">
                                    <strong id="total-calories">0</strong>
                                    <br><small>–∫–∫–∞–ª</small>
                                </div>
                                <div class="col-3">
                                    <strong id="total-protein">0</strong>
                                    <br><small>–±–µ–ª–∫–∏</small>
                                </div>
                                <div class="col-3">
                                    <strong id="total-fat">0</strong>
                                    <br><small>–∂–∏—Ä—ã</small>
                                </div>
                                <div class="col-3">
                                    <strong id="total-carbs">0</strong>
                                    <br><small>—É–≥–ª–µ–≤–æ–¥—ã</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button type="submit" class="btn btn-success btn-lg" id="submit-btn" disabled>
                            <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å <span id="product-count">0</span> –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ –¥–Ω–µ–≤–Ω–∏–∫
                        </button>
                        <a href="{{ url_for('index') }}" class="btn btn-secondary btn-lg">
                            <i class="fas fa-arrow-left"></i> –û—Ç–º–µ–Ω–∞
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- –ü–æ–∏—Å–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ) -->
<div class="modal fade" id="productSearchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ü–æ–∏—Å–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" class="form-control mb-3" id="product-search" 
                       placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞...">
                <div id="search-results"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let productRowIndex = 1;

document.addEventListener('DOMContentLoaded', function() {
    updateTotalNutrition();
    updateSubmitButton();
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
    attachProductRowHandlers(document.querySelector('.product-row'));
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
    document.addEventListener('change', function(e) {
        if (e.target.matches('.product-select') || e.target.matches('.weight-input')) {
            updateSubmitButton();
        }
    });
    
    document.addEventListener('input', function(e) {
        if (e.target.matches('.weight-input')) {
            updateSubmitButton();
        }
    });
});

function addProductRow() {
    const container = document.getElementById('products-container');
    const newRow = document.createElement('div');
    newRow.className = 'product-row mb-3';
    newRow.setAttribute('data-index', productRowIndex);
    
    // –ö–ª–æ–Ω–∏—Ä—É–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É –ø—Ä–æ–¥—É–∫—Ç–∞ –∏ –æ—á–∏—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
    const firstRow = document.querySelector('.product-row');
    const clonedRow = firstRow.cloneNode(true);
    
    // –û—á–∏—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
    const productSelect = clonedRow.querySelector('.product-select');
    const weightInput = clonedRow.querySelector('.weight-input');
    const nutritionPreview = clonedRow.querySelector('.nutrition-preview');
    
    productSelect.selectedIndex = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ "–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç"
    weightInput.value = '';
    nutritionPreview.style.display = 'none';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è
    const deleteBtn = clonedRow.querySelector('.btn-outline-danger');
    deleteBtn.style.display = 'block';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å
    clonedRow.setAttribute('data-index', productRowIndex);
    
    container.appendChild(clonedRow);
    attachProductRowHandlers(clonedRow);
    
    productRowIndex++;
    updateSubmitButton();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è –µ—Å–ª–∏ –±–æ–ª—å—à–µ –æ–¥–Ω–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
    updateDeleteButtons();
}

function removeProductRow(button) {
    const row = button.closest('.product-row');
    row.remove();
    updateTotalNutrition();
    updateSubmitButton();
    updateDeleteButtons();
}

function updateDeleteButtons() {
    const rows = document.querySelectorAll('.product-row');
    const deleteButtons = document.querySelectorAll('.product-row .btn-outline-danger');
    
    deleteButtons.forEach(btn => {
        btn.style.display = rows.length > 1 ? 'block' : 'none';
    });
}

function attachProductRowHandlers(row) {
    const productSelect = row.querySelector('.product-select');
    const weightInput = row.querySelector('.weight-input');
    const nutritionPreview = row.querySelector('.nutrition-preview');
    
    function updateRowNutrition() {
        const selectedOption = productSelect.options[productSelect.selectedIndex];
        const weight = parseFloat(weightInput.value) || 0;
        
        if (selectedOption.value && weight > 0) {
            const calories = parseFloat(selectedOption.dataset.calories) || 0;
            const protein = parseFloat(selectedOption.dataset.protein) || 0;
            const fat = parseFloat(selectedOption.dataset.fat) || 0;
            const carbs = parseFloat(selectedOption.dataset.carbs) || 0;
            
            const factor = weight / 100;
            
            nutritionPreview.querySelector('.calories').textContent = Math.round(calories * factor);
            nutritionPreview.querySelector('.protein').textContent = (protein * factor).toFixed(1);
            nutritionPreview.querySelector('.fat').textContent = (fat * factor).toFixed(1);
            nutritionPreview.querySelector('.carbs').textContent = (carbs * factor).toFixed(1);
            
            nutritionPreview.style.display = 'block';
        } else {
            nutritionPreview.style.display = 'none';
        }
        
        updateTotalNutrition();
        updateSubmitButton();
    }
    
    productSelect.addEventListener('change', updateRowNutrition);
    weightInput.addEventListener('input', updateRowNutrition);
}

function updateTotalNutrition() {
    let totalCalories = 0;
    let totalProtein = 0;
    let totalFat = 0;
    let totalCarbs = 0;
    
    document.querySelectorAll('.product-row').forEach(row => {
        const productSelect = row.querySelector('.product-select');
        const weightInput = row.querySelector('.weight-input');
        const selectedOption = productSelect.options[productSelect.selectedIndex];
        const weight = parseFloat(weightInput.value) || 0;
        
        if (selectedOption.value && weight > 0) {
            const calories = parseFloat(selectedOption.dataset.calories) || 0;
            const protein = parseFloat(selectedOption.dataset.protein) || 0;
            const fat = parseFloat(selectedOption.dataset.fat) || 0;
            const carbs = parseFloat(selectedOption.dataset.carbs) || 0;
            
            const factor = weight / 100;
            
            totalCalories += calories * factor;
            totalProtein += protein * factor;
            totalFat += fat * factor;
            totalCarbs += carbs * factor;
        }
    });
    
    const totalNutrition = document.getElementById('total-nutrition');
    
    if (totalCalories > 0) {
        document.getElementById('total-calories').textContent = Math.round(totalCalories);
        document.getElementById('total-protein').textContent = totalProtein.toFixed(1);
        document.getElementById('total-fat').textContent = totalFat.toFixed(1);
        document.getElementById('total-carbs').textContent = totalCarbs.toFixed(1);
        
        totalNutrition.style.display = 'block';
    } else {
        totalNutrition.style.display = 'none';
    }
}

function updateSubmitButton() {
    const rows = document.querySelectorAll('.product-row');
    let validProducts = 0;
    
    rows.forEach(row => {
        const productSelect = row.querySelector('.product-select');
        const weightInput = row.querySelector('.weight-input');
        
        if (productSelect.value && weightInput.value && parseFloat(weightInput.value) > 0) {
            validProducts++;
        }
    });
    
    const submitBtn = document.getElementById('submit-btn');
    
    submitBtn.disabled = validProducts === 0;
    
    if (validProducts === 0) {
        submitBtn.innerHTML = '<i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å 0 –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ –¥–Ω–µ–≤–Ω–∏–∫';
    } else if (validProducts === 1) {
        submitBtn.innerHTML = '<i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å 1 –ø—Ä–æ–¥—É–∫—Ç –≤ –¥–Ω–µ–≤–Ω–∏–∫';
    } else {
        submitBtn.innerHTML = `<i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å ${validProducts} –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ –¥–Ω–µ–≤–Ω–∏–∫`;
    }
    
    console.log('Valid products count:', validProducts); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
}
</script>
{% endblock %}