{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="text-center mb-4">
            <i class="fas fa-calendar-day"></i> –î–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è
            <small class="text-muted d-block">{{ today.strftime('%d.%m.%Y') }}</small>
        </h1>
    </div>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –¥–µ–Ω—å -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card calorie-card h-100">
            <div class="card-body text-center">
                <h5 class="card-title">
                    <i class="fas fa-fire"></i> –ö–∞–ª–æ—Ä–∏–∏
                </h5>
                <h2 class="mb-1">{{ "%.0f"|format(total_calories) }}</h2>
                <small>–∏–∑ {{ target_calories }} –∫–∫–∞–ª</small>
                <div class="progress mt-2" style="height: 8px;">
                    {% if target_calories > 0 %}
                        {% set progress_width = [total_calories/target_calories*100, 100]|min %}
                    {% else %}
                        {% set progress_width = 0 %}
                    {% endif %}
                    <div class="progress-bar bg-light" data-width="{{ progress_width|round(1) }}"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card protein-card h-100">
            <div class="card-body text-center">
                <h5 class="card-title">
                    <i class="fas fa-dumbbell"></i> –ë–µ–ª–∫–∏
                </h5>
                <h2 class="mb-1">{{ "%.1f"|format(total_protein) }}</h2>
                <small>–≥—Ä–∞–º–º</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card carbs-card h-100">
            <div class="card-body text-center">
                <h5 class="card-title">
                    <i class="fas fa-bread-slice"></i> –£–≥–ª–µ–≤–æ–¥—ã
                </h5>
                <h2 class="mb-1">{{ "%.1f"|format(total_carbs) }}</h2>
                <small>–≥—Ä–∞–º–º</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card fat-card h-100">
            <div class="card-body text-center">
                <h5 class="card-title">
                    <i class="fas fa-tint"></i> –ñ–∏—Ä—ã
                </h5>
                <h2 class="mb-1">{{ "%.1f"|format(total_fat) }}</h2>
                <small>–≥—Ä–∞–º–º</small>
            </div>
        </div>
    </div>
</div>

<!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
<div class="row mb-4">
    <div class="col-12 text-center">
        <a href="{{ url_for('add_food') }}" class="btn btn-primary btn-lg me-3">
            <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –µ–¥—É
        </a>
        <a href="{{ url_for('add_product') }}" class="btn btn-outline-primary btn-lg me-3">
            <i class="fas fa-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç
        </a>
        <a href="{{ url_for('products') }}" class="btn btn-outline-secondary btn-lg">
            <i class="fas fa-list"></i> –í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã
        </a>
    </div>
</div>

<!-- –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ –ø–æ–ø—É–ª—è—Ä–Ω—ã–º –ø—Ä–æ–¥—É–∫—Ç–∞–º -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-star"></i> –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ –ø–æ–ø—É–ª—è—Ä–Ω—ã–º –ø—Ä–æ–¥—É–∫—Ç–∞–º
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 col-sm-6 mb-2">
                        <button class="btn btn-outline-info btn-sm w-100 quick-add-btn" 
                                data-product="–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞" data-weight="100">
                            üçó –ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞ (100–≥)
                        </button>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-2">
                        <button class="btn btn-outline-info btn-sm w-100 quick-add-btn" 
                                data-product="–†–∏—Å –æ—Ç–≤–∞—Ä–Ω–æ–π" data-weight="150">
                            üçö –†–∏—Å –æ—Ç–≤–∞—Ä–Ω–æ–π (150–≥)
                        </button>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-2">
                        <button class="btn btn-outline-info btn-sm w-100 quick-add-btn" 
                                data-product="–Ø–±–ª–æ–∫–æ" data-weight="150">
                            üçé –Ø–±–ª–æ–∫–æ (150–≥)
                        </button>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-2">
                        <button class="btn btn-outline-info btn-sm w-100 quick-add-btn" 
                                data-product="–ú–æ–ª–æ–∫–æ 3.2%" data-weight="200">
                            ü•õ –ú–æ–ª–æ–∫–æ (200–º–ª)
                        </button>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-2">
                        <button class="btn btn-outline-info btn-sm w-100 quick-add-btn" 
                                data-product="–¢–≤–æ—Ä–æ–≥ 5%" data-weight="100">
                            üßÄ –¢–≤–æ—Ä–æ–≥ (100–≥)
                        </button>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-2">
                        <button class="btn btn-outline-info btn-sm w-100 quick-add-btn" 
                                data-product="–ë–∞–Ω–∞–Ω" data-weight="120">
                            üçå –ë–∞–Ω–∞–Ω (120–≥)
                        </button>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-2">
                        <button class="btn btn-outline-info btn-sm w-100 quick-add-btn" 
                                data-product="–Ø–π—Ü–æ –∫—É—Ä–∏–Ω–æ–µ" data-weight="60">
                            ü•ö –Ø–π—Ü–æ (60–≥)
                        </button>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-2">
                        <button class="btn btn-outline-info btn-sm w-100 quick-add-btn" 
                                data-product="–•–ª–µ–± —á–µ—Ä–Ω—ã–π" data-weight="30">
                            üçû –•–ª–µ–± —á–µ—Ä–Ω—ã–π (30–≥)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ü—Ä–∏–µ–º—ã –ø–∏—â–∏ -->
<div class="row">
    {% set meal_icons = {
        '–∑–∞–≤—Ç—Ä–∞–∫': 'fas fa-sun',
        '–æ–±–µ–¥': 'fas fa-clock',
        '—É–∂–∏–Ω': 'fas fa-moon',
        '–ø–µ—Ä–µ–∫—É—Å': 'fas fa-cookie-bite'
    } %}
    
    {% for meal_type, entries in meals.items() %}
    <div class="col-md-6 mb-4">
        <div class="card meal-card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="{{ meal_icons[meal_type] }}"></i> 
                    {{ meal_type.title() }}
                    {% if entries %}
                        <span class="badge bg-light text-dark ms-2">
                            {{ "%.0f"|format(entries|sum(attribute='total_calories')) }} –∫–∫–∞–ª
                        </span>
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                {% if entries %}
                    {% for entry in entries %}
                    <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                        <div>
                            <strong>{{ entry.product.name }}</strong>
                            <small class="text-muted d-block">
                                {{ entry.weight }}–≥ ‚Ä¢ 
                                {{ "%.0f"|format(entry.total_calories) }} –∫–∫–∞–ª ‚Ä¢
                                –ë: {{ "%.1f"|format(entry.total_protein) }}–≥ ‚Ä¢
                                –ñ: {{ "%.1f"|format(entry.total_fat) }}–≥ ‚Ä¢
                                –£: {{ "%.1f"|format(entry.total_carbs) }}–≥
                            </small>
                        </div>
                        <a href="{{ url_for('delete_entry', entry_id=entry.id) }}" 
                           class="btn btn-outline-danger btn-sm"
                           onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')">
                            <i class="fas fa-trash"></i>
                        </a>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted text-center py-3">
                        <i class="fas fa-utensils fa-2x d-block mb-2"></i>
                        –ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ
                    </p>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –∫–∞–ª–æ—Ä–∏—è–º -->
{% if total_calories > 0 %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title text-center">–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –∫–∞–ª–æ—Ä–∏—è–º</h5>
                <div class="progress" style="height: 30px;">
                    {% if target_calories > 0 %}
                    {% set progress_percent = [total_calories/target_calories*100, 100]|min %}
                    {% else %}
                    {% set progress_percent = 0 %}
                    {% endif %}
                    <div class="progress-bar {% if progress_percent > 100 %}bg-danger{% elif progress_percent > 85 %}bg-warning{% else %}bg-success{% endif %}" 
                         data-width="{{ progress_percent|round(1) }}">
                        {{ "%.0f"|format(progress_percent) }}%
                    </div>
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <small class="text-muted">0 –∫–∫–∞–ª</small>
                    <small class="text-muted">{{ target_calories }} –∫–∫–∞–ª</small>
                </div>
                {% if total_calories > target_calories %}
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-triangle"></i>
                        –í—ã –ø—Ä–µ–≤—ã—Å–∏–ª–∏ –¥–Ω–µ–≤–Ω—É—é –Ω–æ—Ä–º—É –Ω–∞ {{ "%.0f"|format(total_calories - target_calories) }} –∫–∫–∞–ª
                    </div>
                {% elif total_calories < target_calories * 0.8 %}
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle"></i>
                        –î–æ –Ω–æ—Ä–º—ã –æ—Å—Ç–∞–ª–æ—Å—å {{ "%.0f"|format(target_calories - total_calories) }} –∫–∫–∞–ª
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–≤ –∏–∑ data-width –∞—Ç—Ä–∏–±—É—Ç–æ–≤
    const progressBars = document.querySelectorAll('.progress-bar[data-width]');
    progressBars.forEach(bar => {
        const width = bar.getAttribute('data-width');
        bar.style.width = width + '%';
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
    const quickAddButtons = document.querySelectorAll('.quick-add-btn');
    
    quickAddButtons.forEach(button => {
        button.addEventListener('click', function() {
            const productName = this.dataset.product;
            const weight = this.dataset.weight;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø—Ä–∏–µ–º–∞ –ø–∏—â–∏
            showMealTypeModal(productName, weight);
        });
    });
});

function showMealTypeModal(productName, weight) {
    const modalHtml = `
        <div class="modal fade" id="quickAddModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å ${productName}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>–í–µ—Å: <strong>${weight}–≥</strong></p>
                        <div class="mb-3">
                            <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–µ–º –ø–∏—â–∏:</label>
                            <select class="form-control" id="quick-meal-type">
                                <option value="–∑–∞–≤—Ç—Ä–∞–∫">üåÖ –ó–∞–≤—Ç—Ä–∞–∫</option>
                                <option value="–æ–±–µ–¥">üåû –û–±–µ–¥</option>
                                <option value="—É–∂–∏–Ω">üåô –£–∂–∏–Ω</option>
                                <option value="–ø–µ—Ä–µ–∫—É—Å">üç™ –ü–µ—Ä–µ–∫—É—Å</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                        <button type="button" class="btn btn-primary" onclick="quickAddProduct('${productName}', ${weight})">
                            –î–æ–±–∞–≤–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –µ—Å–ª–∏ –µ—Å—Ç—å
    const existingModal = document.getElementById('quickAddModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = new bootstrap.Modal(document.getElementById('quickAddModal'));
    modal.show();
}

function quickAddProduct(productName, weight) {
    const mealType = document.getElementById('quick-meal-type').value;
    const today = new Date().toISOString().split('T')[0];
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST –∑–∞–ø—Ä–æ—Å –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞
    fetch('/api/quick_add_food', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            product_name: productName,
            weight: weight,
            meal_type: mealType,
            date: today
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            bootstrap.Modal.getInstance(document.getElementById('quickAddModal')).hide();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showNotification('–ü—Ä–æ–¥—É–∫—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showNotification('–û—à–∏–±–∫–∞: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        showNotification('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–∞', 'error');
    });
}

function showNotification(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const notification = `
        <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', notification);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            if (alert.textContent.includes(message)) {
                alert.remove();
            }
        });
    }, 3000);
}
</script>
{% endblock %}