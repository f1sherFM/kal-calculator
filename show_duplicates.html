{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2>
            <i class="fas fa-exclamation-triangle text-warning"></i> Найденные дубликаты продуктов
        </h2>
        <p class="text-muted">Список продуктов, которые повторяются в базе данных</p>
    </div>
</div>

<!-- Действия -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-tools"></i> Действия по очистке
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex gap-3 flex-wrap">
                    <a href="{{ url_for('cleanup_duplicates') }}" 
                       class="btn btn-danger" 
                       onclick="return confirm('Вы уверены? Это действие удалит все дубликаты, оставив только самые старые записи каждого продукта.')">
                        <i class="fas fa-trash-alt"></i> Очистить все дубликаты
                    </a>
                    <a href="{{ url_for('products') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Вернуться к продуктам
                    </a>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        При очистке будет сохранена самая старая запись каждого продукта (с наименьшим ID). 
                        Все записи в дневнике питания будут автоматически перенаправлены на оригинальный продукт.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Список дубликатов -->
<div class="row">
    <div class="col-12">
        {% if duplicate_details %}
            {% for duplicate in duplicate_details %}
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-copy text-warning"></i>
                        <strong>{{ duplicate.name }}</strong>
                        <span class="badge bg-danger ms-2">{{ duplicate.count }} копий</span>
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Название</th>
                                    <th>Категория</th>
                                    <th>Калории/100г</th>
                                    <th>Белки</th>
                                    <th>Жиры</th>
                                    <th>Углеводы</th>
                                    <th>Дата создания</th>
                                    <th>Статус</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for product in duplicate.products %}
                                <tr class="{% if loop.first %}table-success{% else %}table-danger{% endif %}">
                                    <td>
                                        <span class="badge bg-{% if loop.first %}success{% else %}danger{% endif %}">
                                            {{ product.id }}
                                        </span>
                                    </td>
                                    <td>{{ product.name }}</td>
                                    <td>
                                        <span class="badge bg-secondary">{{ product.category or 'Прочее' }}</span>
                                    </td>
                                    <td>{{ "%.1f"|format(product.calories_per_100g) }} ккал</td>
                                    <td>{{ "%.1f"|format(product.protein) }}г</td>
                                    <td>{{ "%.1f"|format(product.fat) }}г</td>
                                    <td>{{ "%.1f"|format(product.carbs) }}г</td>
                                    <td>
                                        {% if product.created_at %}
                                            {{ product.created_at.strftime('%d.%m.%Y %H:%M') }}
                                        {% else %}
                                            <span class="text-muted">Не указано</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if loop.first %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check"></i> Сохранится
                                            </span>
                                        {% else %}
                                            <span class="badge bg-danger">
                                                <i class="fas fa-trash"></i> Будет удален
                                            </span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endfor %}
            
            <!-- Итоговая статистика -->
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie"></i> Статистика очистки
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <div class="border-end">
                                <h4 class="text-warning">{{ duplicate_details|length }}</h4>
                                <small class="text-muted">Групп дубликатов</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="border-end">
                                <h4 class="text-danger">{{ total_duplicates }}</h4>
                                <small class="text-muted">Продуктов будет удалено</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h4 class="text-success">{{ duplicate_details|length }}</h4>
                            <small class="text-muted">Продуктов останется</small>
                        </div>
                    </div>
                </div>
            </div>
            
        {% else %}
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                    <h4 class="text-success">Дубликаты не найдены!</h4>
                    <p class="text-muted">База данных чистая. Все продукты уникальны.</p>
                    <a href="{{ url_for('products') }}" class="btn btn-primary">
                        <i class="fas fa-list"></i> Вернуться к продуктам
                    </a>
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Добавляем подтверждение для кнопки очистки
    const cleanupBtn = document.querySelector('a[href*="cleanup_duplicates"]');
    if (cleanupBtn) {
        cleanupBtn.addEventListener('click', function(e) {
            const confirmed = confirm(
                'ВНИМАНИЕ! Это действие необратимо!\n\n' +
                'Будут удалены {{ total_duplicates }} дубликатов.\n' +
                'Останется {{ duplicate_details|length }} уникальных продуктов.\n\n' +
                'Все записи в дневнике питания будут автоматически перенаправлены на оригинальные продукты.\n\n' +
                'Продолжить?'
            );
            
            if (!confirmed) {
                e.preventDefault();
            }
        });
    }
});
</script>
{% endblock %}